import { initializeApp } from "firebase/app";
import { getDatabase, ref, set, get, onValue, off, update, remove } from "firebase/database";

const firebaseConfig = {
  apiKey: "AIzaSyDeAi2zWvn1EmMs2oU-7pCGFltJp_79QWY",
  authDomain: "villaquerencia-79bd9.firebaseapp.com",
  databaseURL: "https://lotex-ai-real-estate-crm-37933698510.us-west1.run.app",
  projectId: "villaquerencia-79bd9",
  storageBucket: "villaquerencia-79bd9.firebasestorage.app",
  messagingSenderId: "529349394900",
  appId: "1:529349394900:web:4dcbf97ac6e69909331641",
  measurementId: "G-4N9F9LQTF6"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

export interface Lead {
  id: string; // phone number used as ID
  name: string;
  phone: string;
  source: 'Instagram' | 'Landing' | 'WhatsApp';
  stage: 'New' | 'Conversation' | 'Meeting_Booked';
  history: string[]; // Log of messages or summary
  timestamp: number;
  tasks?: string[]; // Array of assigned tasks
}

/**
 * Saves or updates a lead in the database under 'leads/{phoneNumber}'
 * Uses 'update' to prevent overwriting existing fields like 'tasks'
 */
export const saveLead = async (lead: Lead): Promise<void> => {
  const leadId = lead.phone; 
  const leadRef = ref(db, `leads/${leadId}`);
  
  // Use update to merge with existing data
  await update(leadRef, { ...lead, id: leadId });
  
  // Fallback: Save to localStorage for resilience
  localStorage.setItem(`lead_${leadId}`, JSON.stringify(lead));
};

/**
 * Updates only the name of an existing lead
 */
export const updateLeadName = async (phoneNumber: string, name: string): Promise<void> => {
  const leadRef = ref(db, `leads/${phoneNumber}`);
  await update(leadRef, { name });
  
  // Update local storage fallback as well
  const localData = localStorage.getItem(`lead_${phoneNumber}`);
  if (localData) {
      const parsed = JSON.parse(localData);
      parsed.name = name;
      localStorage.setItem(`lead_${phoneNumber}`, JSON.stringify(parsed));
  }
};

/**
 * Retrieves a specific lead by phone number
 */
export const getLead = async (phoneNumber: string): Promise<Lead | null> => {
  try {
    const leadRef = ref(db, `leads/${phoneNumber}`);
    const snapshot = await get(leadRef);
    if (snapshot.exists()) {
      return snapshot.val() as Lead;
    }
  } catch (e) {
    console.warn("Firebase fetch failed, trying localStorage", e);
  }
  
  // Fallback to localStorage
  const localData = localStorage.getItem(`lead_${phoneNumber}`);
  if (localData) return JSON.parse(localData) as Lead;

  return null;
};

/**
 * Adds a task string to a specific lead
 */
export const addTaskToLead = async (phoneNumber: string, task: string): Promise<void> => {
  const leadRef = ref(db, `leads/${phoneNumber}`);
  const snapshot = await get(leadRef);
  
  if (snapshot.exists()) {
    const lead = snapshot.val() as Lead;
    const currentTasks = lead.tasks || [];
    const updatedTasks = [...currentTasks, task];
    
    await update(leadRef, { 
      tasks: updatedTasks,
      stage: 'Meeting_Booked' // Auto update stage if task is added
    });
  }
};

/**
 * Deletes a specific lead by phone number
 */
export const deleteLead = async (phoneNumber: string): Promise<void> => {
  const leadRef = ref(db, `leads/${phoneNumber}`);
  await remove(leadRef);
};

/**
 * Subscribes to changes in the 'leads' node. 
 * Returns an unsubscribe function.
 */
export const subscribeToLeads = (callback: (leads: Lead[]) => void) => {
  const leadsRef = ref(db, 'leads');
  
  const handleValueChange = (snapshot: any) => {
    const data = snapshot.val();
    if (data) {
      // Convert Firebase object (keyed by ID) to an Array
      const leadList = Object.values(data) as Lead[];
      // Sort by newest first
      leadList.sort((a, b) => b.timestamp - a.timestamp);
      callback(leadList);
    } else {
      callback([]);
    }
  };

  const unsubscribe = onValue(leadsRef, handleValueChange);

  // Return function to stop listening
  return () => off(leadsRef, 'value', handleValueChange);
};
